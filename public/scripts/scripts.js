"use strict";function config(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl as main",resolve:{postPromise:["$asset",function(a){return a.sync()}]}}).when("/Admin",{templateUrl:"views/admin.html",controller:"AdminCtrl as admin",resolve:{postPromise:["$asset",function(a){return a.sync()}]}}),b.html5Mode({enabled:!1,requireBase:!1}),b.hashPrefix("!")}function run(){FastClick.attach(document.body)}angular.module("isuApp",["foundation","ngAnimate","ngCookies","ngProgress","ngResource","ngSanitize","ngMap","ngRoute","ngFileUpload"]).config(config).run(run),config.$inject=["$routeProvider","$locationProvider"],angular.module("isuApp").controller("MainCtrl",["NgMap","$timeout","FoundationApi","$filter","$login","$asset","ModalFactory","Upload","ngProgressFactory","$scope",function(a,b,c,d,e,f,g,h,i,j){function k(a){var b=a.address_components,c=a.photos,e=a.types[0];return{nm:a.name,ad:{ct:l(b,"locality"),st:l(b,"route"),nr:l(b,"street_number")},gid:a.id,tp:0==d("filter")(p,{value:e}).length?"oth_er":e,gps:a.geometry.location.toJSON(),pt:c?c[0].getUrl({maxWidth:400,maxHeight:250}):"http://placekitten.com/g/400/200",sf:4}}function l(a,b){for(var c=-1,d=0,e=a.length;e>d;d++)if(a[d].types[0]==b){c=d;break}return-1==c?" ----- ":a[c].short_name}var m,n=this,o={selection:function(a){n.isSelected=angular.isObject(a),n.isSelected?(n.selected=k(a),m=n.markers.push(f.make(n.selected))-1,n.map.setCenter(a.geometry.location)):(n.markers[m]=f.remake(m),n.selected={},m=-1,n.usC.isOwner=!1)},emphasize:function(a){var b=a.place.gps;n.isSelected=!0,n.selected=a.place,m=a.index,n.map.setCenter({lat:parseFloat(b.lat),lng:parseFloat(b.lng)})}},p=[{value:"amusement_park",text:"Parc de distractii"},{value:"aquarium",text:"Acvariu"},{value:"art_gallery",text:"Galerie de arta"},{value:"bakery",text:"Brutarie"},{value:"bank",text:"Banca"},{value:"bar",text:"Bar"},{value:"beauty_salon",text:"Salon infrumusetare"},{value:"bicycle_store",text:"Magazin de biciclete"},{value:"book_store",text:"Librarie"},{value:"bowling_alley",text:"Sala de bowling"},{value:"cafe",text:"Cafenea"},{value:"campground",text:"Campare"},{value:"casino",text:"Casino"},{value:"church",text:"Biserica"},{value:"city_hall",text:"Primarie"},{value:"clothing_store",text:"Magazin de imbracaminte"},{value:"convenience_store",text:"Mini Market"},{value:"courthouse",text:"Tribunal"},{value:"food",text:"Mancare"},{value:"grocery_or_supermarket",text:"Magazin"},{value:"gym",text:"Sala de fitness"},{value:"hair_care",text:"Salon ingrijirea parului"},{value:"health",text:"Sanatate"},{value:"home_goods_store",text:"Magazin pentru casa"},{value:"hospital",text:"Spital"},{value:"library",text:"Biblioteca"},{value:"airport",text:"Aeroport"},{value:"movie_theater",text:"Cinematograf"},{value:"museum",text:"Muzeu"},{value:"night_club",text:"Club de noapte"},{value:"parking",text:"Parcare"},{value:"place_of_worship",text:"Capela"},{value:"police",text:"Politie"},{value:"post_office",text:"Oficiu Postal"},{value:"restaurant",text:"Restaurant"},{value:"school",text:"Scoala"},{value:"shopping_mall",text:"Centru comercial / Mall"},{value:"spa",text:"Centru de wellness"},{value:"stadium",text:"Stadion"},{value:"department_store",text:"Supermarket"},{value:"electronics_store",text:"Magazin electronice"},{value:"embassy",text:"Ambasada"},{value:"local_government_office",text:"Birou administratie locala"},{value:"mosque",text:"Moschee"},{value:"store",text:"Magazin"},{value:"subway_station",text:"Statie de metrou"},{value:"synagogue",text:"Sinagoga"},{value:"university",text:"Universitate"},{value:"zoo",text:"Gradina zoologica"},{value:"oth_er",text:"Diverse"}];angular.extend(n,{giveUp:function(){c.publish("menu","close"),o.selection()},goBack:function(){n.usC.isOwner=!1},goOn:function(){return n.usC.isOwner?(n.selected.hf=!0,void n.upload()):n.selected.isOwner?void(n.usC.isOwner=!0):n.selected.sf<4?void c.publish("menu","close"):void f.push(n.selected).success(function(){c.publish("noti-success",{title:"SUCCESS!",content:"Ati adaugat "+n.selected.nm+" in lista locatiilor fara Autorizatie ISU."}),n.usC.isOwner||c.publish("menu","close"),o.selection()})},isSelected:!1,logout:function(a){a.stopPropagation(),e.logout(),n.usC.isLogged=!1,c.publish("user-btn","close"),c.publish("noti-success",{title:"Success!",content:"Ati fost deautentificat din sistem!",color:"success",autoclose:2500})},options:p,placeChanged:function(){var a=this.getPlace(),b=f.hasPlace(a.id);b?o.emphasize(b):o.selection(a),c.publish("menu","open")},progress:!1,selectAsset:function(){var a=this.listIndex;console.log(a),o.emphasize({place:f.get("places",a),index:a}),c.publish("menu","open")},upload:function(){var a=n.files;if(a&&a.length)for(var d=0;d<a.length;d++){var g=a[d];g.$error||(j.progressbar=i.createInstance(),j.progressbar.start(),h.upload({url:"/assets/upload",data:{uid:e.get("_id"),file:g}}).then(function(a){b(function(){n.selected.frm||(n.selected.frm={}),n.selected.frm.at||(n.selected.frm.at={}),n.selected.frm.at.file=a.data,n.selected.sf=1,f.update(n.selected).success(function(){c.publish("noti-success",{title:"SUCCESS!",content:"Ati adaugat "+n.selected.nm+" in lista locatiilor cu Autorizatie ISU.",color:"success"}),n.markers[m]=f.remake(m),c.publish("menu","close"),o.selection(),j.progressbar.complete()}).error(function(a){console.log(a)})})},null,function(a){j.progressbar.set(parseInt(100*a.loaded/a.total))}))}},userBtn:function(a){if(console.log(a),!n.usC.isLogged){a.stopPropagation(),n.user={};var b=new g({"class":"tiny",overlay:!0,overlayClose:!1,templateUrl:"views/userModal.html",contentScope:{action:function(a){e.make(a,n.user).then(function(d){var e={};d.success?(e={title:"Success!",content:"login"==a?"Sunteti autentificat in sistem!":"Ati fost inregistrat in sistem!",color:"success"},n.usC.isLogged=!0,n.usC.isAdmin=0==d.user.rl,b.deactivate()):(e={title:"Eroare!",content:d.reason,color:"alert"},n.user.pw=""),e.autoclose=2500,c.publish("noti-success",e)})},user:n.user}});b.activate()}},usC:e.init()}),a.getMap().then(function(a){n.map=a,n.markers=f.get("markers")})}]),angular.module("isuApp").controller("AdminCtrl",["$asset","$login","ModalFactory","$scope",function(a,b,c,d){var e=this;angular.extend(e,{assets:a.get("places")}),angular.forEach(e.assets,function(b){b.showAsset=function(){var d="views/show"+(b.hf?"Owned":"")+"Asset.html";console.log(d);var e=new c({"class":b.hf?"medium":"tiny",overlay:!0,overlayClose:!1,templateUrl:d,contentScope:{asset:b,close:function(){e.deactivate()},markAs:function(c){console.log(c),b.sf=c,b.style=a.getStyle(c),a.update(b).then(function(){e.deactivate()})}}});e.activate()}})}]).directive("needsClick",["$timeout",function(a){return{restrict:"A",link:function(b,c){c.bind("keydown keypress",function(){function b(a){angular.element(a).addClass("needsclick")}a(function(){var a=angular.element(document.getElementsByClassName("pac-item"));angular.forEach(a,function(a){b(a),angular.forEach(angular.element(a).find("span"),function(a){b(a)})})},500)})}}}]),angular.module("isuApp").factory("$asset",["$q","$http",function(a,b){function c(a){return{icon:{path:MAP_PIN,fillColor:d[a.sf],fillOpacity:.8,strokeColor:"",strokeWeight:0},status:a.sf,listIndex:a.index,address:"["+a.gps.lat+","+a.gps.lng+"]","class":"map-icon-"+a.tp.replace(/_/g,"-")}}var d=["#00CCBB","#FFDD77","#FF6B6B","#444","#005599"],e={sync:!1,markers:[],places:[]};return{hasPlace:function(a){for(var b=0,c=e.places.length;c>b;b++){var d=e.places[b];if(d.gid==a)return{index:b,place:d}}return!1},sync:function(){return e.sync?void 0:b.get("/assets").success(function(a){angular.forEach(a,function(a,b){a.index=b,a.style={"background-color":d[a.sf],opacity:.6},e.places.push(a),e.markers.push(c(a)),e.sync=!0})})},get:function(a,b){var c=e[a];return b?c[b]:c},getStyle:function(a){return{"background-color":d[a],opacity:.6}},make:function(a){return c(a)},push:function(a){return e.places.push(a),b.post("/assets",a)},remake:function(a){return c(e.places[a])},update:function(a){return b.post("/assets/update",a)}}}]),angular.module("isuApp").factory("$login",["$q","$http","$cookies",function(a,b,c){var d=!1,e={_id:function(){return d?d._id:!1},user:function(){return d}};return{get:function(a){return e[a]()},init:function(){return d=c.getObject("loggedIn"),{isLogged:angular.isObject(d),isAdmin:d?0==d.rl:!1,isOwner:!1}},logout:function(){d=!1,c.remove("loggedIn")},make:function(e,f){var g=a.defer();return b.post("/users/"+e,f).success(function(a){a.success&&(d=a.user,c.putObject("loggedIn",d)),g.resolve(a)}),g.promise}}}]);